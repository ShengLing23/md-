---
typora-copy-images-to: img
---

#### TCP的可靠性保证

+ 应用数据被分割成TCP任务最适合发送的数据块
+ 当TCP发出一个段后，它启动一个定时器，等待目的端确认收到这个报文段。如果不能及时收到一个确认，将重发这个报文段
+ 当TCP收到发自TCP连接另一端的数据，它将发送一个确认。
+ TCP将保持它首部和数据的校验和。
+ 既然TCP报文段作为IP数据报来传输，而IP数据报的到达可能会失序，因此TCP报文段的到达也可能会失序。如果必要，TCP将对收到的数据进行重新排序，将收到的数据以正确的顺序交给应用层
+ 既然IP数据报会发生重复，TCP的接收端必须丢弃重复的数据
+ TCP还能提供流程控制。TCP连接端的每一方都有固定大小的缓冲空间。TCP的接收端只允许另一端发送接收端缓冲区所能接纳额数据

#### TCP首部

​	TCP首部，通常是20个字节。

![1548325239098](G:\md笔记\img\1548325239098.png)

| 名称                 | 含义                                                         |
| -------------------- | ------------------------------------------------------------ |
| 源端口号和目的端口号 | 用于寻找发端和收端的应用进程；这两个值加上IP首部中的源端IP和目的端IP,唯一确定一个TCP连接 |
| 32位序号             | 标识这个报文段中的第一个数据字节。TCP用序号对每个字节进行计数。序号是32bit 的无符号数，序号到达2^32 -1后又从0开始 |
| 32位确认序号         | 确认序号包含发送确认的一端，所期望收到的下一个序号。<br>因此确认序号应当是上次已成功收到数据字节序号+1 |
| 4位首部长度          | 首部中32 bit的数目；所以，tcp首部最多为15*4=60字节。         |
| 16位窗口大小         | 为字节数；起始于确认序号指明的值，这个值是接收端期望接收的字节数 |
| 16位校验和           |                                                              |
| 16位紧急指针         | 当URG=1时，起作用；和序号值相加，表示紧急数据的最后一个字节的序号 |

| 标志位 | 含义                                 |
| ------ | ------------------------------------ |
| URG    | 紧急指针（有效）                     |
| ACK    | 确认序号有效                         |
| PSH    | 接收方应该尽快将这个报文段交给应用层 |
| RST    | 重建连接                             |
| SYN    | 同步序号，用来发起一个连接           |
| FIN    | 发送端完成发送任务                   |

#### TCP连接和终止

##### 1、建立连接

```sequence
title:TCP三次握手
客户端->服务端:1、SYN=1;初始序号ISN（c）
服务端->客户端:2、SYN=1;初始序号ISN（s）;ACK=1;INS(c)+1
客户端->服务端:3、ACK=1;ISN(s)+1
```

​	3个报文段完成连接的建立，这个过程称之为三次握手；

​	当一端为建立连接而发送它的SYN时，它为连接选择一个初始序号。ISN随时间而变化。

##### 2、终止连接

```sequence
title:TCP4次握手
客户端->服务端:FIN(C)=1
服务端->客户端:ACK
服务端->客户端:FIN(S)=1
客户端->服务端:ACK
```

​	TCP连接是全双工连接，因此每个方向必须进行单独的关闭

























